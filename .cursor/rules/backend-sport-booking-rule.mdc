---
alwaysApply: true
---
# Cursor Rules для sport-booking-backend

## Архитектура проекта
Проект использует feature-based модульную архитектуру с TypeScript, Express.js и Supabase.

## Технологический стек
- Runtime: Node.js
- Язык: TypeScript (строгая типизация)
- Framework: Express.js
- Аутентификация: Supabase Auth
- База данных: Supabase (PostgreSQL)
- Документация: Swagger/OpenAPI
- Контейнеризация: Docker

## Правила разработки

### Структура кода
- Новые модули: src/feature-name/ с подпапками (api, middleware, model, routes)
- Обязательные папки: /config, /utils, /types, /constants
- Один модуль = один файл максимум 300 строк

### TypeScript
- Строгая типизация (strict: true)
- Интерфейсы для всех request/response
- Избегать `any`, использовать `unknown`
- Типизировать все функции и middleware

### Маршруты и API
- Все эндпоинты в swagger.yaml
- Защищённые маршруты через authMiddleware
- Валидация входящих данных (Joi/Zod)
- Единый формат: {  T } или { error: string }
- Try-catch во всех async функциях

### Безопасность
- Все секреты только в .env
- Строгая CORS конфигурация
- Не логировать пароли, токены, личные данные

### Аутентификация
- Токены через: Cookie auth_token (приоритет) или Bearer token
- Время жизни cookie: 7 дней
- Проверка через supabaseAdmin.auth.getUser()

### База данных
- Supabase клиент для запросов
- supabaseAdmin с service role для админ операций
- Не хранить пароли в открытом виде

### Логирование
- Логировать: ошибки, важные операции (auth), API запросы
- НЕ логировать: пароли, токены, ПД, номера карт

### Docker
- docker-compose для разработки и продакшена
- Multi-stage build для оптимизации
- Переменные окружения через .env
- Не хранить билд-артефакты в репо

### Code Style
- Использовать ESLint + Prettier для кодстайла
- Отступы: 2 пробела
- Точка с запятой: обязательно
- Кавычки: одинарные
- Макс длина строки: 100 символов

## Примеры

### Создание роута
1. Создать интерфейс (model)
2. Создать API метод
3. Создать роут с валидацией и try-catch

### Обработка ошибок
try {
  // код
} catch (error) {
  if (error instanceof Error) {
    res.status(400).json({ error: error.message });
  } else {
    res.status(500).json({ error: 'Internal server error' });
  }
}

## Что НЕ делать
❌ Не использовать any тип
❌ Не коммитить .env
❌ Не хранить секреты в коде
❌ Не пропускать валидацию
❌ Не игнорировать ошибки
❌ Не создавать god-объекты > 300 строк
❌ Не мешать бизнес-логику с HTTP логикой
❌ Не использовать синхронные I/O операции
❌ Не добавлять эндпоинты без документации в Swagger

## Приоритеты
1. Безопасность
2. Типобезопасность
3. Читаемость кода
4. Документация (Swagger)
5. Производительность